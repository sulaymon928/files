$sela(".card-check-link").forEach(btn => $on(btn,"click",e => cardCheckModal(e)))

if($get("script",false) === "card-check")
    visualiseCard($get("id"),false)

function cardCheckModal(e=null) {
    if(e) e .preventDefault()
    osModal({
        body: `<div class="modal-content" style="background: rgba(251, 247, 240, 1); padding: 5px">
            <div class="modal-body">
                <div class="m11-modal">
                    <h6 class="text-center text-primary mb-3">CHECK CARD</h6>
                    <h2 class="text-center mb-3">Visualize Gift Card</h2>
                    <p class="text-center mb-3">Check for a gift card details through<br>proper graphical visualization</p>
                    <div class="form-group">
                        <label class="text-left d-block">Card ID</label>
                        <input class="form-control card-uid" style="border-radius: 0" placeholder="Enter Card Unique ID">
                    </div>
                    <div>
                        <button type="button" class="btn btn-outline-dark osai-close-box">Cancel</button>
                        <button class="btn btn-primary card-check-btn">Check Gift Card</button>
                    </div>
                </div>
            </div>
        </div>`,
        operation: () =>{
            $style(CusWind.get.head).display = "none";
            $style(CusWind.get.foot).display = "none";
            $style(CusWind.get.body).margin = "auto";
            $style(CusWind.get.body).padding = "0";
            $on($sel(".osai-close-box"),"click", CusWind.closeBox)

            let btn = $sel(".card-check-btn");
            $on(btn,"click",e => {
                e.preventDefault()
                let val = $sel(".card-uid").value;
                if(val.trim() === "") return osNote("Please enter a valid unique id. Ex. itmxxx","fail")
                visualiseCard(encodeURIComponent(val));
            })
        }
    })
}

function visualiseCard(cardId, usePreloader = true) {
    $curl($gifty("res").ctrl + "adm_gift&intent_gift=1.9&gift_param_1=" + cardId,{
        preload: () => {
            if(usePreloader) {
                $preloader("show")
                Preloader("show")
            }
            else
                osNote("Generating your gift card, please wait","info",{position: "center"})
        },
        type: "json"
    }).finally(() =>{
        $preloader("hide")
        Preloader("hide")
        if(usePreloader === false){
            $style($sel(".gift-box-container"),"display:block; position: relative; z-index:11")
            $on($sel(".gift-box-container"),"click",() => visualiseCard($get("id")))
        }
    }).then(res => {
        if(res.code === 1) {
            let card = res.details
            let vendor = res.vendor
            let mediaType = "";
            let icon = "";

            switch (card.file_type){
                case "mp3":
                    icon = `<i class="fas fa-music"></i>`;
                    mediaType = `<audio src="${card.file}" controls style="max-width: 100%">Your browser does not support this content</audio>`
                break;
                case "mp4":
                    icon = `<i class="fas fa-video"></i>`;
                    mediaType = `<video src="${card.file}" controls style="max-width: 100%">Your browser does not support this content</video>`
                break;
                case "jpg":case "png":case "jpeg":
                    icon = `<i class="fas fa-images"></i>`;
                    mediaType = `<img src="${card.file}" class="img-fluid" alt="Personalized Image">`
                break;
                default:break;
            }

            let media = mediaType !== "" ? `<details class="form-group row mb-4 card-attachment-details">
                <summary class="col-md-12 mb-0 mb-md-2 font-weight-bold card-attachment">${icon}</summary>
                <div class="col-md-12 mb-0 mb-md-2 text-center">${mediaType}</div>
            </details>` : ""

            osModal({
                size: "lg",
                body: `<div class="modal-content position-relative" style="background: rgba(251, 247, 240, 1); padding: 5px">
                    <div class="position-absolute d-md-block d-none">
                        <img style="height: 245px" class="img-fluid" src="${$gifty('res').img_custom}new/ribbon.png" alt="ribbon">
                    </div>
                    <div class="modal-body">
                        <div class="m11-modal">
                            <div class="text-center mb-3 mb-md-5">
                                <img style="height: 60px" class="img-fluid" src="${$gifty('res').kraft}images/uikit-pages/kraft8-logo.png" alt="logo">
                            </div>
                            <p class="text-center mb-0"><b>${card.sender_name}</b> sent you</p>
                            <h3 class="text-center mb-3 mb-md-5">${$gifty('gen').currency(card.amount)}</h3>
                            <div class="d-flex bg-primary br-25 mb-3 mb-md-5 justify-content-center align-items-center p-3 flex-wrap">
                                <div class="mr-3 text-white text-uppercase" style="font-size: .8rem">Voucher Code</div> <h4 class="text-white mb-0">${card.code}</h4>
                            </div>
                            <div class="form-group row mb-2">
                                <p class="col-md-4 mb-0 mb-md-2 font-weight-bold text-left">Unique ID</p>
                                <p class="col-md-8 mb-0 mb-md-2 text-left">${card.unique_id}</p>
                            </div>
                            <div class="form-group row mb-2">
                                <p class="col-md-4 mb-0 mb-md-2 font-weight-bold text-left">Redeem At</p>
                                <p class="col-md-8 mb-0 mb-md-2 text-left">${vendor.vend_name}</p>
                            </div>
                            <div class="form-group row mb-2">
                                <p class="col-md-4 mb-0 mb-md-2 font-weight-bold text-left">Recipient</p>
                                <p class="col-md-8 mb-0 mb-md-2 text-left">${card.to_name}</p>
                            </div>
                            <div class="form-group row mb-2">
                                <p class="col-md-4 mb-0 mb-md-2 font-weight-bold text-left">Valid Until</p>
                                <p class="col-md-8 mb-0 mb-md-2 text-left">${$gifty('gen').date(card.expiry_date)}</p>
                            </div>
                            <div class="form-group row mb-4">
                                <p class="col-md-4 mb-0 mb-md-2 font-weight-bold text-left">Message</p>
                                <p class="col-md-8 mt-0 mb-0 text-left"><i>${card.sender_note}</i></p>
                            </div>${media}
                            <p class="text-left mb-3">To redeem your voucher, kindly provide the Voucher Code above only on request of the merchant.</p>
                            <hr class="mt-0 mb-4">
                            <div class="d-flex flex-wrap justify-content-center">
                                <button class="btn btn-primary download-card mr-md-auto mx-md-0 mx-auto">Download</button>
                                <a href="terms" class="btn btn-outline-dark osai-close-box">TERMS & CONDITIONS</a>
                            </div>
                        </div>
                    </div>
                </div>`,
                operation: () =>{
                    $style(CusWind.get.head).display = "none";
                    $style(CusWind.get.foot).display = "none";
                    $style(CusWind.get.body).margin = "auto";
                    $style(CusWind.get.body).padding = "0";

                    $on($sel(".download-card"),"click",() =>{
                        osNote("Please wait...","info")
                        downloadGiftCard()
                    })
                }
            })
        }
        else if(res.code === 2)
            osNote(res.msg,"warn")
        else
            osNote(res.msg,"fail")
    })
}

function downloadGiftCard() {
    html2pdf().set({filename: "mygiftcard.pdf"}).from($html(CusWind.get.body)).save()
}